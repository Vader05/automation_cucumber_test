name: Run API Tests and Report to Xray

on:
  workflow_dispatch:      # permite ejecuci贸n manual desde GitHub UI
  repository_dispatch:  # permite lanzarlo desde Jira/Xray v铆a API

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Cucumber tests
        # Agregamos 'continue-on-error: true' para que el workflow contin煤e
        # incluso si hay fallos en los tests, asegurando la subida de resultados.
        continue-on-error: true 
        run: |
          chmod +x mvnw
          ./mvnw test

      # PASO 1: Obtener Token de Xray
      # El token se exporta a GITHUB_ENV para que est茅 disponible en el siguiente paso.
      - name: Get Xray Token
        id: get_token
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        # Se ejecuta siempre.
        if: always()
        run: |
          # 1. Obtener token de Xray
          XRAY_TOKEN=$(curl -s -X POST "https://xray.cloud.getxray.app/api/v2/authenticate" \
            -H "Content-Type: application/json" \
            -d "{\"client_id\": \"${XRAY_CLIENT_ID}\", \"client_secret\": \"${XRAY_CLIENT_SECRET}\"}" | tr -d '"')

          # 2. Exportar el token para el siguiente paso
          echo "XRAY_TOKEN=${XRAY_TOKEN}" >> $GITHUB_ENV
          
          # 3. Impresi贸n para depuraci贸n
          echo "Token obtenido y exportado."
          echo "Token (primeros 10 caracteres): ${XRAY_TOKEN::10}..."


      # PASO 2: Subir Resultados a Xray (usando testExecutionKey)
      - name: Upload Cucumber results to Xray
        # Se ejecuta siempre.
        if: always()
        run: |
          REPORT_FILE="target/cucumber.json"

          #  CLAVE DE TU PROYECTO: P123 (del ticket P123-14)
          #  CLAVE DE LA EJECUCIN: P123-14 (Test Execution existente)
          TEST_EXECUTION_KEY="P123-14" 

          # 1. Verificar si el token existe
          if [ -z "${XRAY_TOKEN}" ]; then
            echo "Error: XRAY_TOKEN no se pudo obtener. Saltando subida de resultados."
            exit 0
          fi

          # 2. Verificar la existencia del archivo
          if [ ! -f "$REPORT_FILE" ]; then
            echo "ERROR CRTICO: Archivo de reporte no encontrado en $REPORT_FILE."
            exit 1 
          fi

          # *** PASO CLAVE DE DIAGNSTICO ***
          echo "=================================================="
          echo "Contenido de $REPORT_FILE (DEBUG):"
          cat $REPORT_FILE
          echo "=================================================="
          
          # 3. Subir Resultados (Cambiamos a /preimport para VALIDAR el formato)
          echo "Iniciando VALIDACIN del formato JSON con /preimport..."
          
          CURL_RESPONSE=$(curl -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/cucumber/preimport?testExecutionKey=$TEST_EXECUTION_KEY" \
            -H "Authorization: Bearer ${XRAY_TOKEN}" \
            -F "file=@$REPORT_FILE")

          echo "=================================================="
          echo "RESPUESTA DE XRAY /preimport (Busque errores de formato aqu铆):"
          echo $CURL_RESPONSE
          echo "=================================================="

          # Si la preimportaci贸n es exitosa, procedemos a la importaci贸n real
          if echo $CURL_RESPONSE | grep -q 'error'; then
            echo "La preimportaci贸n fall贸. El JSON tiene un error de formato o est谩 incompleto."
            exit 0
          else
            echo "Preimportaci贸n exitosa. Iniciando IMPORTACIN real..."
            # Ahora importamos de verdad
            curl -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/cucumber?testExecutionKey=$TEST_EXECUTION_KEY" \
              -H "Authorization: Bearer ${XRAY_TOKEN}" \
              -F "file=@$REPORT_FILE"
          fi