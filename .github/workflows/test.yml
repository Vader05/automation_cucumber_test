name: Run API Tests and Report to Xray

on:
  workflow_dispatch:    # permite ejecución manual desde GitHub UI
  repository_dispatch:  # permite lanzarlo desde Jira/Xray vía API

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Cucumber tests
        run: |
          chmod +x mvnw
          ./mvnw test

      - name: Upload Cucumber results to Xray
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        run: |
          # Obtener token de Xray (respuesta: "ey...token...")
          XRAY_TOKEN=$(curl -s -X POST "https://xray.cloud.getxray.app/api/v2/authenticate" \
            -H "Content-Type: application/json" \
            -d "{\"client_id\": \"${XRAY_CLIENT_ID}\", \"client_secret\": \"${XRAY_CLIENT_SECRET}\"}" | tr -d '"')

          echo "Token obtenido: ${XRAY_TOKEN::10}... (oculto por seguridad)"

          # Ajusta la ruta del archivo si tu Cucumber lo deja en otro sitio
          curl -s -X POST "https://xray.cloud.getxray.app/api/v2/import/execution/cucumber" \
            -H "Authorization: Bearer ${XRAY_TOKEN}" \
            -F "file=@target/cucumber-reports/Cucumber.json"
